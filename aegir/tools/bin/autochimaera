#!/bin/bash


###----------------------------------------###
###
###  Automatic BOA System Major Upgrade Tool
###
###  Copyright (C) 2010-2023 Omega8.cc
###  noc@omega8.cc www.omega8.cc
###
###  This program is free software. You can
###  redistribute it and/or modify it under
###  the terms of the GNU GPL as published by
###  the Free Software Foundation, version 2
###  or later.
###
###  This program is distributed in the hope
###  that it will be useful, but WITHOUT ANY
###  WARRANTY; without even the implied
###  warranty of MERCHANTABILITY or FITNESS
###  FOR A PARTICULAR PURPOSE. See the GNU GPL
###  for more details.
###
###  You should have received a copy of the
###  GNU GPL along with this program.
###  If not, see http://www.gnu.org/licenses/
###
###  Code: https://github.com/omega8cc/boa
###
###----------------------------------------###


###----------------------------------------###
### HOW-TO: Command to launch auto-upgrade ###
###----------------------------------------###
###
###    touch /root/.run-to-chimaera.cnf
###
###  Once enabled, the system will launch
###  a series of barracuda up-head and reboots
###  until it migrates any supported Debian
###  or Devuan version to Devuan Chimaera.
###
###  !!! WARNING !!!
###
###  EXPECT IT TO CRASH COMPLETELY, SO ONLY
###  FULL RESTORE FROM LATEST BACKUP SNAPSHOT
###  OF ENTIRE VM WILL BRING IT BACK TO LIVE.
###
###  DO NOT PROCEED UNTIL YOU ARE READY FOR
###  DISASTER RECOVERY FROM TESTED BACKUP!
###
###----------------------------------------###


###----------------------------------------###
### DON'T EDIT ANYTHING BELOW THIS LINE    ###
###----------------------------------------###

export PATH=$PATH:/opt/local/bin
SHELL=/bin/bash
barCnf="/root/.barracuda.cnf"

###
### Avoid too many questions
###
export DEBIAN_FRONTEND=noninteractive
export APT_LISTCHANGES_FRONTEND=none
if [ -z "${TERM+x}" ]; then
  export TERM=vt100
fi

_TODAY=$(date +%y%m%d 2>&1)
_TODAY=${_TODAY//[^0-9]/}
_X_SE="414prodT60"
_THIS_SYS=check
#

check_root() {
  if [ `whoami` = "root" ]; then
    ionice -c2 -n7 -p $$
    renice 19 -p $$
    chmod a+w /dev/null
    if [ ! -e "/dev/fd" ]; then
      if [ -e "/proc/self/fd" ]; then
        rm -rf /dev/fd
        ln -s /proc/self/fd /dev/fd
      fi
    fi
  else
    echo "ERROR: This script should be ran as a root user"
    exit 1
  fi
  _DF_TEST=$(df -kTh / -l \
    | grep '/' \
    | sed 's/\%//g' \
    | awk '{print $6}' 2> /dev/null)
  _DF_TEST=${_DF_TEST//[^0-9]/}
  if [ ! -z "${_DF_TEST}" ] && [ "${_DF_TEST}" -gt "90" ]; then
    echo "ERROR: Your disk space is almost full !!! ${_DF_TEST}/100"
    echo "ERROR: We can not proceed until it is below 90/100"
    exit 1
  fi
}
check_root

if [ ! -e "/root/.run-to-chimaera.cnf" ] \
  || [ ! -e "${barCnf" ]; then
  exit 1
fi

if [ -e "/root/.run-to-chimaera.cnf" ]; then
  echo "Waiting 120 seconds for the system start scripts to finish"
  sleep 120
fi

_AUTO_CHIMAERA_TEST=$(grep _AUTO_CHIMAERA ${barCnf} 2>&1)
if [[ ! "${_AUTO_CHIMAERA_TEST}" =~ "_AUTO_CHIMAERA" ]]; then
  echo "_AUTO_CHIMAERA=YES" >> ${barCnf}
fi

if [ -e "/root/.run-to-chimaera.cnf" ] \
  && [ ! -e "/root/.run-auto-major-os-reboot-one.cnf" ] \
  && [ ! -e "/root/.run-auto-major-os-reboot-two.cnf" ]; then
  echo
  echo "Launching standard barracuda up-head system first"
  barracuda up-head system
  wait
  echo "The initial barracuda up-head system completed"
  if [ -e "/root/.latest-barracuda-upgrade-finale.info" ]; then
    _THIS_OS=$(lsb_release -si 2>&1)
    _THIS_SYS=$(lsb_release -sc 2>&1)
    if [ -e "/root/.beowulf_to_chimaera_major_os_upgrade.info" ] \
      || [ -e "/root/.bullseye_to_chimaera_major_os_upgrade.info" ]; then
      _REAL_OS="Devuan"
      _REAL_OSR="chimaera"
    else
      _REAL_OS="${_THIS_OS}"
      _REAL_OSR="${_THIS_SYS}"
    fi
    if [ "${_REAL_OSRR}" = "jessie" ]; then
      echo _JESSIE_TO_BEOWULF=YES >> ${barCnf}
      echo "Launching major upgrade from ${_REAL_OS}/${_REAL_OSR} to Devuan/beowulf"
    elif [ "${_REAL_OSRR}" = "stretch" ]; then
      echo _STRETCH_TO_BEOWULF=YES >> ${barCnf}
      echo "Launching major upgrade from ${_REAL_OS}/${_REAL_OSR} to Devuan/beowulf"
    elif [ "${_REAL_OSRR}" = "buster" ]; then
      echo _BUSTER_TO_BEOWULF=YES >> ${barCnf}
      echo "Launching major upgrade from ${_REAL_OS}/${_REAL_OSR} to Devuan/beowulf"
    elif [ "${_REAL_OSR}" = "bullseye" ]; then
      echo _BULLSEYE_TO_CHIMAERA=YES >> ${barCnf}
      echo "Launching major upgrade from ${_REAL_OS}/${_REAL_OSR} to Devuan/chimaera"
    elif [ "${_REAL_OSR}" = "beowulf" ]; then
      echo _BEOWULF_TO_CHIMAERA=YES >> ${barCnf}
      echo "Launching major upgrade from ${_REAL_OS}/${_REAL_OSR} to Devuan/chimaera"
    fi
    echo "The first stage of major OS upgrade will start now"
    barracuda up-head system
    wait
    if [ -e "/root/.run_post_major_os_upgrade.info" ]; then
      echo "The first stage of major OS upgrade completed"
      echo "The system will reboot now"
      rm -f /root/.latest-barracuda-upgrade-finale.info
      touch /root/.run-auto-major-os-reboot-one.cnf
      reboot
    fi
  fi
fi

if [ -e "/root/.run-to-chimaera.cnf" ] \
  && [ -e "/root/.run-auto-major-os-reboot-one.cnf" ] \
  && [ ! -e "/root/.run-auto-major-os-reboot-two.cnf" ]; then
  echo
  echo "Launching post-reboot barracuda up-head system"
  echo "to complete the first stage of major OS upgrade"
  barracuda up-head system
  wait
  echo "The post-reboot barracuda up-head system completed"
  echo
  _THIS_OS=$(lsb_release -si 2>&1)
  _THIS_SYS=$(lsb_release -sc 2>&1)
  if [ -e "/root/.beowulf_to_chimaera_major_os_upgrade.info" ] \
    || [ -e "/root/.bullseye_to_chimaera_major_os_upgrade.info" ]; then
    _REAL_OS="Devuan"
    _REAL_OSR="chimaera"
    _FURTHER_UPGRADE=NO
  else
    _REAL_OS="${_THIS_OS}"
    _REAL_OSR="${_THIS_SYS}"
    _FURTHER_UPGRADE=YES
  fi
  if [ "${_FURTHER_UPGRADE}" = "NO" ]; then
    if [ -e "/root/.latest-barracuda-upgrade-finale.info" ]; then
      echo "The single stage major OS upgrade completed"
      echo "The system will reboot now for a final upgrade"
      rm -f /root/.latest-barracuda-upgrade-finale.info
      touch /root/.run-auto-major-os-reboot-two.cnf
      reboot
    fi
  fi
  if [ "${_REAL_OSR}" = "bullseye" ] && [ "${_FURTHER_UPGRADE}" = "YES" ]; then
    echo _BULLSEYE_TO_CHIMAERA=YES >> ${barCnf}
    echo "Launching major upgrade from ${_REAL_OS}/${_REAL_OSR} to Devuan/chimaera"
  elif [ "${_REAL_OSR}" = "beowulf" ] && [ "${_FURTHER_UPGRADE}" = "YES" ]; then
    echo _BEOWULF_TO_CHIMAERA=YES >> ${barCnf}
    echo "Launching major upgrade from ${_REAL_OS}/${_REAL_OSR} to Devuan/chimaera"
  fi
  if [ "${_FURTHER_UPGRADE}" = "YES" ]; then
    echo "The second stage of major OS upgrade will start now"
    barracuda up-head system
    wait
    if [ -e "/root/.run_post_major_os_upgrade.info" ]; then
      echo "The second stage of major OS upgrade completed"
      echo "The system will reboot now"
      rm -f /root/.latest-barracuda-upgrade-finale.info
      touch /root/.run-auto-major-os-reboot-two.cnf
      reboot
    fi
  fi
fi

if [ -e "/root/.run-to-chimaera.cnf" ] \
  && [ -e "/root/.run-auto-major-os-reboot-one.cnf" ] \
  && [ -e "/root/.run-auto-major-os-reboot-two.cnf" ]; then
  echo
  echo "Launching final post-reboot barracuda up-head system"
  barracuda up-head system
  wait
  rm -f /root/.run-to-chimaera.cnf
  sed -i "s/^_AUTO_CHIMAERA.*//g" /root/.barracuda.cnf
  echo "The final post-reboot barracuda up-head system completed"
  echo "That's all folks!"
  echo "Bye!"
  echo
fi

exit 0
